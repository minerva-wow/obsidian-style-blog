<!-- templates/blog/home.html -->
{% extends 'blog/base.html' %} {% block title %}Home - Graph View{% endblock %}
{% block content %}
<!-- 添加一个额外的容器来确保正确的尺寸 -->
<div class="graph-container relative rounded-xl" id="graph">
  <!-- 控制按钮 -->
  <div class="zoom-controls">
    <button class="zoom-button" title="Zoom In">+</button>
    <button class="zoom-button" title="Zoom Out">-</button>
    <button class="zoom-button" title="Reset">⟲</button>
  </div>
</div>
{% endblock %} {% block extra_js %}
<!-- 确保先引入 D3.js -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<style>
  .graph-container {
    width: 100%;
    height: 80vh;
    min-height: 600px;
    position: relative;
    margin: 1rem 0;
  }

  .zoom-controls {
    position: absolute;
    top: 20px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 8px;
    backdrop-filter: blur(4px);
    z-index: 10;
  }

  .zoom-button {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 4px;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .zoom-button:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .graph-link {
    stroke: #4a5568;
    stroke-width: 1.5;
    opacity: 0.6;
  }

  .node-label {
    font-size: 12px;
    fill: #fff;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
  }
</style>

<script>
    
  // 性能优化的力导向图实现
  document.addEventListener("DOMContentLoaded", function () {
    // 基础配置
    const config = {
      nodeSizes: {
        post: { outer: 12, inner: 6 },
        tag: { outer: 8, inner: 4 },
      },
      colors: {
        post: "#50fa7b", 
      },
      forces: {
        link: 100, // 连接距离
        charge: -100, // 节点间斥力
        collision: 30, // 碰撞半径
      },
    };

    // 初始化图形
    const container = document.querySelector(".graph-container");
    const width = container.clientWidth;
    const height = container.clientHeight;

    // 使用内存效率更高的SVG创建方式
    const svg = d3
      .create("svg")
      .attr("width", width)
      .attr("height", height)
      .attr("viewBox", [0, 0, width, height]);

    container.appendChild(svg.node());

    const g = svg.append("g");

    // 优化的缩放行为
    const zoom = d3
      .zoom()
      .scaleExtent([0.2, 4])
      .on("zoom", (event) => {
        g.attr("transform", event.transform);
      });

    // 添加双击复位功能
    svg
      .call(zoom)
      .on("dblclick.zoom", null)
      .on("dblclick", () => {
        svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity);
      });

    // 优化的力导向配置
    const simulation = d3
      .forceSimulation()
      .force(
        "link",
        d3
          .forceLink()
          .id((d) => d.id)
          .distance(config.forces.link)
      )
      .force(
        "charge",
        d3
          .forceManyBody()
          .strength(config.forces.charge)
          // 添加最小/最大距离限制提高性能
          .distanceMin(10)
          .distanceMax(width / 2)
      )
      .force("center", d3.forceCenter(width / 2, height / 2))
      .force("collision", d3.forceCollide().radius(config.forces.collision))
      // 添加alpha衰减控制
      .alphaDecay(0.02)
      .alphaMin(0.001);

    // 使用防抖处理窗口调整
    let resizeTimeout;
    window.addEventListener("resize", () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        const newWidth = container.clientWidth;
        const newHeight = container.clientHeight;
        svg.attr("width", newWidth).attr("height", newHeight);
        simulation.force("center", d3.forceCenter(newWidth / 2, newHeight / 2));
        simulation.alpha(0.3).restart();
      }, 250);
    });

    // 优化的数据加载和渲染
    fetch('{% url "blog:graph-data" %}')
      .then((response) => response.json())
      .then((data) => {
        // 使用虚拟DOM技术批量创建元素
        const link = g
          .append("g")
          .selectAll("line")
          .data(data.links)
          .join("line")
          .attr("class", "graph-link")

        const node = g
          .append("g")
          .selectAll("g")
          .data(data.nodes)
          .join("g")
          .call(
            d3
              .drag()
              .subject((d) => d)
              .on("start", dragstarted)
              .on("drag", dragged)
              .on("end", dragended)
          );

        // 优化的节点渲染
        node.each(function (d) {
          const group = d3.select(this);
          const isPost = d.type === "post";

          group
            .append("circle")
            .attr("r", (d) => config.nodeSizes[d.type].inner)
            .attr("fill", (d) => (isPost ? config.colors.post : d.color))
            .style("filter", "blur(2px)")

          // 优化的文本标签
          group
            .append("text")
            .text(d.label)
            .attr("x", 12)
            .attr("y", 4)
            .attr("class", "node-label")
        });

        // 优化的点击处理
        node.on("click", (event, d) => {
          event.preventDefault();
          const url =
            d.type === "post" ? `/post/${d.slug}/` : `/tag/${d.label}/`;
          window.location.href = url;
        });

        // 优化的动画循环
        simulation.nodes(data.nodes).on("tick", () => {
          // 使用requestAnimationFrame优化渲染
          requestAnimationFrame(() => {
            link
              .attr("x1", (d) => d.source.x)
              .attr("y1", (d) => d.source.y)
              .attr("x2", (d) => d.target.x)
              .attr("y2", (d) => d.target.y);

            node.attr("transform", (d) => `translate(${d.x},${d.y})`);
          });
        });

        simulation.force("link").links(data.links);
      })
      .catch((error) => console.error("Error fetching graph data:", error));

    // 优化的拖拽处理函数
    function dragstarted(event, d) {
      if (!event.active) simulation.alphaTarget(0.3).restart();
      d.fx = d.x;
      d.fy = d.y;
    }

    function dragged(event, d) {
      d.fx = event.x;
      d.fy = event.y;
    }

    function dragended(event, d) {
      if (!event.active) simulation.alphaTarget(0);
      d.fx = null;
      d.fy = null;
    }
  });
</script>
{% endblock %}
